<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Route Planner - Marine Organism Tracker</title>
    <link rel="stylesheet" href="../css/main.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="module" src="https://static.rocket.new/rocket-web.js?_cfg=https%3A%2F%2Ffishingro2722back.builtwithrocket.new&_be=https%3A%2F%2Fapplication.rocket.new&_v=0.1.5"></script>
</head>
<body class="bg-background font-inter">
    <!-- Navigation Header -->
    <nav class="bg-white shadow-card border-b border-slate-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo -->
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <svg class="h-8 w-8 text-primary" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                            <circle cx="12" cy="8" r="2" fill="currentColor"/>
                            <path d="M12 10c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/>
                        </svg>
                    </div>
                    <div class="ml-3">
                        <h1 class="text-xl font-bold text-primary">Route Planner</h1>
                    </div>
                </div>

                <!-- Desktop Navigation -->
                <div class="hidden md:block">
                    <div class="ml-10 flex items-baseline space-x-4">
                        <a href="interactive_map_dashboard_homepage.html" class="text-slate-600 hover:text-primary px-3 py-2 rounded-md text-sm font-medium transition-maritime">Map Dashboard</a>
                        <a href="route_planner_optimization.html" class="bg-primary-100 text-primary px-3 py-2 rounded-md text-sm font-medium">Route Planner</a>
                        <a href="weather_marine_conditions_center.html" class="text-slate-600 hover:text-primary px-3 py-2 rounded-md text-sm font-medium transition-maritime">Weather</a>
                        <a href="community_feed_social_platform.html" class="text-slate-600 hover:text-primary px-3 py-2 rounded-md text-sm font-medium transition-maritime">Community</a>
                        <a href="equipment_hub_gear_optimizer.html" class="text-slate-600 hover:text-primary px-3 py-2 rounded-md text-sm font-medium transition-maritime">Equipment</a>
                        <a href="learning_center_fishing_education.html" class="text-slate-600 hover:text-primary px-3 py-2 rounded-md text-sm font-medium transition-maritime">Learning</a>
                    </div>
                </div>

                <!-- CTA Button -->
                <div class="hidden md:block">
                    <button class="maritime-button-primary" id="plan-route">Plan Route</button>
                </div>

                <!-- Mobile menu button -->
                <div class="md:hidden">
                    <button type="button" class="text-slate-600 hover:text-primary p-2" id="mobile-menu-button">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Mobile Navigation Menu -->
        <div class="md:hidden hidden" id="mobile-menu">
            <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3 bg-white border-t border-slate-200">
                <a href="interactive_map_dashboard_homepage.html" class="text-slate-600 hover:text-primary block px-3 py-2 rounded-md text-base font-medium">Map Dashboard</a>
                <a href="route_planner_optimization.html" class="bg-primary-100 text-primary block px-3 py-2 rounded-md text-base font-medium">Route Planner</a>
                <a href="weather_marine_conditions_center.html" class="text-slate-600 hover:text-primary block px-3 py-2 rounded-md text-base font-medium">Weather</a>
                <a href="community_feed_social_platform.html" class="text-slate-600 hover:text-primary block px-3 py-2 rounded-md text-base font-medium">Community</a>
                <a href="equipment_hub_gear_optimizer.html" class="text-slate-600 hover:text-primary block px-3 py-2 rounded-md text-base font-medium">Equipment</a>
                <a href="learning_center_fishing_education.html" class="text-slate-600 hover:text-primary block px-3 py-2 rounded-md text-base font-medium">Learning</a>
                <div class="px-3 py-2">
                    <button class="maritime-button-primary w-full text-center" id="mobile-plan-route">Plan Route</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex h-screen overflow-hidden">
        <!-- Left Sidebar - Route Planning Parameters -->
        <aside class="w-80 bg-white shadow-card border-r border-slate-200 overflow-y-auto">
            <div class="p-6">
                <h2 class="text-lg font-semibold text-slate-900 mb-6">Route Planning</h2>

                <!-- Route Type -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-slate-700 mb-2">Route Type</label>
                    <select class="maritime-input" id="route-type">
                        <option value="fishing">Fishing Route</option>
                        <option value="exploration">Exploration Route</option>
                        <option value="research">Research Route</option>
                        <option value="emergency">Emergency Route</option>
                    </select>
                </div>

                <!-- Distance Unit -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-slate-700 mb-2">Distance Unit</label>
                    <select class="maritime-input" id="distance-unit">
                        <option value="km">Kilometers</option>
                        <option value="miles">Miles</option>
                        <option value="nm">Nautical Miles</option>
                    </select>
                </div>

                <!-- Waypoints List -->
                <div class="mb-6">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-sm font-medium text-slate-700">Waypoints</h3>
                        <button class="text-primary text-sm hover:text-primary-800" id="add-waypoint">+ Add</button>
                    </div>
                    <div class="space-y-2" id="waypoints-list">
                        <div class="text-sm text-slate-500 text-center py-4">Click on map to add waypoints</div>
                    </div>
                </div>

                <!-- Route Optimization -->
                <div class="mb-6">
                    <h3 class="text-sm font-medium text-slate-700 mb-3">Route Optimization</h3>
                    <div class="space-y-2">
                        <label class="flex items-center">
                            <input type="checkbox" class="rounded border-slate-300 text-primary focus:ring-primary" checked id="shortest-path" />
                            <span class="ml-2 text-sm text-slate-700">Shortest path</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" class="rounded border-slate-300 text-primary focus:ring-primary" id="avoid-obstacles" />
                            <span class="ml-2 text-sm text-slate-700">Avoid obstacles</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" class="rounded border-slate-300 text-primary focus:ring-primary" checked id="organism-tracking" />
                            <span class="ml-2 text-sm text-slate-700">Track organisms</span>
                        </label>
                    </div>
                </div>

                <!-- Organism Tracking Range -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-slate-700 mb-2">Organism Tracking Range</label>
                    <div class="flex items-center space-x-2">
                        <input type="range" class="flex-1 h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer" min="0.5" max="5" step="0.5" value="2" id="tracking-range" />
                        <span class="text-sm text-slate-600 w-16" id="range-value">2.0 km</span>
                    </div>
                </div>

                <!-- Target Organisms -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-slate-700 mb-2">Target Organisms</label>
                    <div class="space-y-2">
                        <label class="flex items-center">
                            <input type="checkbox" class="rounded border-slate-300 text-primary focus:ring-primary" checked />
                            <span class="ml-2 text-sm text-slate-700">Bamboo Sea Corals</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" class="rounded border-slate-300 text-primary focus:ring-primary" />
                            <span class="ml-2 text-sm text-slate-700">Kelp Forest Giants</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" class="rounded border-slate-300 text-primary focus:ring-primary" />
                            <span class="ml-2 text-sm text-slate-700">Marine Grass Varieties</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" class="rounded border-slate-300 text-primary focus:ring-primary" />
                            <span class="ml-2 text-sm text-slate-700">Flexible Seaweed Strands</span>
                        </label>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="space-y-3">
                    <button class="maritime-button-primary w-full" id="calculate-route">Calculate Route</button>
                    <button class="maritime-button-secondary w-full" id="save-route">Save Route</button>
                    <button class="w-full px-4 py-2 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 transition-maritime" id="clear-route">Clear Route</button>
                </div>
            </div>
        </aside>

        <!-- Main Map Area -->
        <div class="flex-1 relative">
            <!-- Map Container -->
            <div id="route-map" class="w-full h-full"></div>

            <!-- Route Controls Overlay -->
            <div class="absolute top-4 left-4 z-40">
                <div class="maritime-card p-4">
                    <h3 class="text-sm font-semibold text-slate-700 mb-3">Route Tools</h3>
                    <div class="space-y-2">
                        <button class="w-full text-left px-3 py-2 text-sm bg-primary-100 text-primary rounded-md font-medium" id="add-waypoint-mode">
                            <svg class="inline h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                            </svg>
                            Add Waypoint
                        </button>
                        <button class="w-full text-left px-3 py-2 text-sm text-slate-600 hover:bg-slate-100 rounded-md transition-maritime" id="show-organisms">
                            <svg class="inline h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                            </svg>
                            Show Organisms
                        </button>
                        <button class="w-full text-left px-3 py-2 text-sm text-slate-600 hover:bg-slate-100 rounded-md transition-maritime" id="show-distances">
                            <svg class="inline h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                            </svg>
                            Show Distances
                        </button>
                    </div>
                </div>
            </div>

            <!-- Route Summary Overlay -->
            <div class="absolute top-4 right-4 z-40">
                <div class="maritime-card p-4 w-72">
                    <h3 class="text-sm font-semibold text-slate-700 mb-3">Route Summary</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-slate-600">Total Distance:</span>
                            <span class="font-medium text-slate-900" id="total-distance">0 km</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-600">Waypoints:</span>
                            <span class="font-medium text-slate-900" id="waypoint-count">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-600">Estimated Time:</span>
                            <span class="font-medium text-slate-900" id="estimated-time">0 min</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-600">Organisms Found:</span>
                            <span class="font-medium text-success-600" id="organisms-found">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-600">Route Status:</span>
                            <span class="font-medium text-accent-600" id="route-status">Planning</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Sidebar - Route Analysis -->
        <aside class="w-96 bg-white shadow-card border-l border-slate-200 overflow-y-auto">
            <div class="p-6">
                <h2 class="text-lg font-semibold text-slate-900 mb-6">Route Analysis</h2>

                <!-- Distance Chart -->
                <div class="mb-6">
                    <h3 class="text-sm font-medium text-slate-700 mb-3">Distance Breakdown</h3>
                    <div class="maritime-card p-4">
                        <canvas id="distance-chart" width="300" height="150"></canvas>
                    </div>
                </div>

                <!-- Waypoint Details -->
                <div class="mb-6">
                    <h3 class="text-sm font-medium text-slate-700 mb-3">Waypoint Details</h3>
                    <div class="space-y-3" id="waypoint-details">
                        <div class="text-sm text-slate-500 text-center py-4">No waypoints added yet</div>
                    </div>
                </div>

                <!-- Organism Tracking Results -->
                <div class="mb-6">
                    <h3 class="text-sm font-medium text-slate-700 mb-3">Organism Tracking</h3>
                    <div class="space-y-3" id="organism-results">
                        <div class="maritime-card p-4 border-l-4 border-l-success-400">
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-medium text-slate-900">Bamboo Sea Corals</h4>
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-success-100 text-success-800">Active</span>
                            </div>
                            <div class="text-sm text-slate-600">
                                <div class="flex justify-between">
                                    <span>Detected:</span>
                                    <span class="font-medium">12 clusters</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Avg Distance:</span>
                                    <span class="font-medium">1.3 km</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Quality:</span>
                                    <span class="font-medium text-success-600">Excellent</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="maritime-card p-4 border-l-4 border-l-primary-400">
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-medium text-slate-900">Marine Grass</h4>
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-primary-100 text-primary-800">Monitoring</span>
                            </div>
                            <div class="text-sm text-slate-600">
                                <div class="flex justify-between">
                                    <span>Detected:</span>
                                    <span class="font-medium">8 areas</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Avg Distance:</span>
                                    <span class="font-medium">0.8 km</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Quality:</span>
                                    <span class="font-medium text-primary-600">Good</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Route Optimization Suggestions -->
                <div class="mb-6">
                    <h3 class="text-sm font-medium text-slate-700 mb-3">Optimization Suggestions</h3>
                    <div class="maritime-card p-4">
                        <div class="space-y-3">
                            <div class="flex items-start space-x-3">
                                <div class="flex-shrink-0 w-2 h-2 bg-success-500 rounded-full mt-2"></div>
                                <div class="text-sm">
                                    <div class="font-medium text-slate-900">Reorder waypoints</div>
                                    <div class="text-slate-600">Could save 2.3 km by optimizing order</div>
                                </div>
                            </div>
                            <div class="flex items-start space-x-3">
                                <div class="flex-shrink-0 w-2 h-2 bg-warning-500 rounded-full mt-2"></div>
                                <div class="text-sm">
                                    <div class="font-medium text-slate-900">Add organism stop</div>
                                    <div class="text-slate-600">High-density coral area 0.5 km away</div>
                                </div>
                            </div>
                            <div class="flex items-start space-x-3">
                                <div class="flex-shrink-0 w-2 h-2 bg-accent-500 rounded-full mt-2"></div>
                                <div class="text-sm">
                                    <div class="font-medium text-slate-900">Weather consideration</div>
                                    <div class="text-slate-600">Avoid northern route during high winds</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Export Options -->
                <div class="space-y-3">
                    <button class="maritime-button-primary w-full" id="export-route">Export Route</button>
                    <button class="maritime-button-secondary w-full" id="share-route">Share Route</button>
                    <button class="w-full px-4 py-2 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 transition-maritime" id="route-history">View History</button>
                </div>
            </div>
        </aside>
    </main>

    <!-- Footer -->
    <footer class="bg-slate-900 text-white py-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center">
                <p class="text-slate-400">© 2025 Route Planner. All Rights Reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        // Initialize map
        let routeMap;
        let waypoints = [];
        let routeMarkers = [];
        let routePolylines = [];
        let distanceMarkers = [];
        let organismMarkers = [];
        let routePolygons = [];
        let totalDistance = 0;
        let addingWaypoint = false;

        // Distance calculation function
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Convert distance based on unit
        function convertDistance(distanceKm, unit) {
            switch(unit) {
                case 'miles':
                    return distanceKm * 0.621371;
                case 'nm':
                    return distanceKm * 0.539957;
                default:
                    return distanceKm;
            }
        }

        // Format distance display
        function formatDistance(distance, unit) {
            const converted = convertDistance(distance, unit);
            return `${converted.toFixed(1)} ${unit}`;
        }

        function initRouteMap() {
            // Initialize the map
            routeMap = L.map('route-map').setView([20.5937, 78.9629], 5);

            // Add tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(routeMap);

            // Add click handler for adding waypoints
            routeMap.on('click', function(e) {
                if (addingWaypoint) {
                    addWaypoint(e.latlng.lat, e.latlng.lng);
                }
            });

            // Initialize organism locations
            initializeOrganisms();
        }

        function initializeOrganisms() {
            const organisms = [
                {
                    lat: 37.7749,
                    lng: -122.4194,
                    type: 'Bamboo Sea Coral',
                    quality: 'Excellent',
                    density: 'High'
                },
                {
                    lat: 37.7849,
                    lng: -122.4094,
                    type: 'Marine Grass',
                    quality: 'Good',
                    density: 'Medium'
                },
                {
                    lat: 37.7949,
                    lng: -122.3994,
                    type: 'Kelp Forest',
                    quality: 'Excellent',
                    density: 'High'
                },
                {
                    lat: 37.7649,
                    lng: -122.4294,
                    type: 'Flexible Seaweed',
                    quality: 'Good',
                    density: 'Medium'
                }
            ];

            organisms.forEach(organism => {
                const marker = L.circleMarker([organism.lat, organism.lng], {
                    radius: 8,
                    fillColor: organism.quality === 'Excellent' ? '#10b981' : '#f59e0b',
                    color: '#ffffff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8,
                    className: 'organism-marker'
                });

                marker.bindPopup(`
                    <div class="p-3 min-w-48">
                        <h3 class="font-semibold text-slate-900 mb-2">${organism.type}</h3>
                        <div class="space-y-1 text-sm">
                            <div class="flex justify-between">
                                <span class="text-slate-600">Quality:</span>
                                <span class="font-medium text-slate-900">${organism.quality}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-600">Density:</span>
                                <span class="font-medium text-slate-900">${organism.density}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-600">Distance:</span>
                                <span class="font-medium text-slate-900" id="organism-distance-${organism.lat}-${organism.lng}">-</span>
                            </div>
                        </div>
                    </div>
                `);

                organismMarkers.push(marker);
            });
        }

        function addWaypoint(lat, lng) {
            const waypointIndex = waypoints.length;
            const waypoint = {
                lat: lat,
                lng: lng,
                index: waypointIndex,
                name: `Waypoint ${waypointIndex + 1}`
            };

            waypoints.push(waypoint);

            // Create marker
            const marker = L.marker([lat, lng], {
                draggable: true,
                className: 'route-marker'
            }).addTo(routeMap);

            // Add popup
            marker.bindPopup(`
                <div class="p-3 min-w-48">
                    <h3 class="font-semibold text-slate-900 mb-2">${waypoint.name}</h3>
                    <div class="space-y-1 text-sm">
                        <div class="flex justify-between">
                            <span class="text-slate-600">Coordinates:</span>
                            <span class="font-medium text-slate-900">${lat.toFixed(4)}, ${lng.toFixed(4)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-600">Distance from prev:</span>
                            <span class="font-medium text-slate-900" id="waypoint-distance-${waypointIndex}">-</span>
                        </div>
                    </div>
                    <div class="mt-3 flex space-x-2">
                        <button class="px-2 py-1 bg-accent text-white text-xs rounded" onclick="removeWaypoint(${waypointIndex})">Remove</button>
                    </div>
                </div>
            `);

            // Handle marker drag
            marker.on('dragend', function(e) {
                const newPos = e.target.getLatLng();
                waypoint.lat = newPos.lat;
                waypoint.lng = newPos.lng;
                updateRoute();
            });

            routeMarkers.push(marker);
            updateRoute();
            updateWaypointsList();
        }

        function removeWaypoint(index) {
            if (routeMarkers[index]) {
                routeMap.removeLayer(routeMarkers[index]);
                routeMarkers.splice(index, 1);
                waypoints.splice(index, 1);
                
                // Update indices
                waypoints.forEach((wp, i) => {
                    wp.index = i;
                    wp.name = `Waypoint ${i + 1}`;
                });
                
                updateRoute();
                updateWaypointsList();
            }
        }

        function updateRoute() {
            // Clear existing route lines and distance markers
            routePolylines.forEach(line => routeMap.removeLayer(line));
            distanceMarkers.forEach(marker => routeMap.removeLayer(marker));
            routePolylines = [];
            distanceMarkers = [];
            totalDistance = 0;

            if (waypoints.length < 2) {
                updateRouteSummary();
                return;
            }

            const unit = document.getElementById('distance-unit').value;

            // Draw route lines and add distance markers
            for (let i = 0; i < waypoints.length - 1; i++) {
                const start = waypoints[i];
                const end = waypoints[i + 1];
                
                // Calculate distance
                const distance = calculateDistance(start.lat, start.lng, end.lat, end.lng);
                totalDistance += distance;

                // Draw route line
                const polyline = L.polyline([
                    [start.lat, start.lng],
                    [end.lat, end.lng]
                ], {
                    color: '#0369a1',
                    weight: 3,
                    opacity: 0.8,
                    className: 'route-line'
                }).addTo(routeMap);

                routePolylines.push(polyline);

                // Add distance marker at midpoint
                const midLat = (start.lat + end.lat) / 2;
                const midLng = (start.lng + end.lng) / 2;
                
                const distanceMarker = L.marker([midLat, midLng], {
                    icon: L.divIcon({
                        className: 'distance-marker',
                        html: `<div class="bg-accent text-white px-2 py-1 rounded text-xs font-medium">${formatDistance(distance, unit)}</div>`,
                        iconSize: [60, 24],
                        iconAnchor: [30, 12]
                    })
                }).addTo(routeMap);

                distanceMarkers.push(distanceMarker);
            }

            updateRouteSummary();
            updateOrganismDistances();
            updateWaypointDetails();
        }

        function updateRouteSummary() {
            const unit = document.getElementById('distance-unit').value;
            document.getElementById('total-distance').textContent = formatDistance(totalDistance, unit);
            document.getElementById('waypoint-count').textContent = waypoints.length;
            
            // Estimate time (assuming 5 km/h average speed)
            const timeMinutes = Math.round((totalDistance / 5) * 60);
            document.getElementById('estimated-time').textContent = `${timeMinutes} min`;
            
            // Update status
            const status = waypoints.length === 0 ? 'Planning' : 
                          waypoints.length === 1 ? 'Add waypoint' : 
                          'Route ready';
            document.getElementById('route-status').textContent = status;
        }

        function updateOrganismDistances() {
            if (waypoints.length === 0) return;

            let organismsInRange = 0;
            const trackingRange = parseFloat(document.getElementById('tracking-range').value);
            
            organismMarkers.forEach(marker => {
                const orgPos = marker.getLatLng();
                let minDistance = Infinity;
                
                // Find minimum distance to any waypoint
                waypoints.forEach(waypoint => {
                    const distance = calculateDistance(waypoint.lat, waypoint.lng, orgPos.lat, orgPos.lng);
                    minDistance = Math.min(minDistance, distance);
                });
                
                // Update popup with distance
                const unit = document.getElementById('distance-unit').value;
                const distanceElement = document.getElementById(`organism-distance-${orgPos.lat}-${orgPos.lng}`);
                if (distanceElement) {
                    distanceElement.textContent = formatDistance(minDistance, unit);
                }
                
                if (minDistance <= trackingRange) {
                    organismsInRange++;
                    marker.setStyle({ fillOpacity: 0.9, radius: 10 });
                } else {
                    marker.setStyle({ fillOpacity: 0.4, radius: 8 });
                }
            });
            
            document.getElementById('organisms-found').textContent = organismsInRange;
        }

        function updateWaypointsList() {
            const waypointsList = document.getElementById('waypoints-list');
            
            if (waypoints.length === 0) {
                waypointsList.innerHTML = '<div class="text-sm text-slate-500 text-center py-4">Click on map to add waypoints</div>';
                return;
            }
            
            waypointsList.innerHTML = waypoints.map((wp, index) => `
                <div class="flex items-center justify-between p-2 border border-slate-200 rounded-md">
                    <div class="flex items-center space-x-2">
                        <div class="w-6 h-6 bg-primary text-white rounded-full flex items-center justify-center text-xs font-medium">
                            ${index + 1}
                        </div>
                        <div class="text-sm">
                            <div class="font-medium text-slate-900">${wp.name}</div>
                            <div class="text-slate-500">${wp.lat.toFixed(4)}, ${wp.lng.toFixed(4)}</div>
                        </div>
                    </div>
                    <button class="text-accent hover:text-accent-600 text-sm" onclick="removeWaypoint(${index})">Remove</button>
                </div>
            `).join('');
        }

        function updateWaypointDetails() {
            const waypointDetails = document.getElementById('waypoint-details');
            
            if (waypoints.length === 0) {
                waypointDetails.innerHTML = '<div class="text-sm text-slate-500 text-center py-4">No waypoints added yet</div>';
                return;
            }
            
            const unit = document.getElementById('distance-unit').value;
            let cumulativeDistance = 0;
            
            waypointDetails.innerHTML = waypoints.map((wp, index) => {
                let segmentDistance = 0;
                if (index > 0) {
                    segmentDistance = calculateDistance(
                        waypoints[index - 1].lat, waypoints[index - 1].lng,
                        wp.lat, wp.lng
                    );
                    cumulativeDistance += segmentDistance;
                }
                
                return `
                    <div class="maritime-card p-3 border-l-4 border-l-primary">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-medium text-slate-900">${wp.name}</h4>
                            <span class="text-xs text-slate-500">#${index + 1}</span>
                        </div>
                        <div class="text-sm text-slate-600 space-y-1">
                            <div class="flex justify-between">
                                <span>Coordinates:</span>
                                <span class="font-medium">${wp.lat.toFixed(4)}, ${wp.lng.toFixed(4)}</span>
                            </div>
                            ${index > 0 ? `
                                <div class="flex justify-between">
                                    <span>Segment distance:</span>
                                    <span class="font-medium">${formatDistance(segmentDistance, unit)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Cumulative:</span>
                                    <span class="font-medium">${formatDistance(cumulativeDistance, unit)}</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Initialize distance chart
        function initDistanceChart() {
            const ctx = document.getElementById('distance-chart').getContext('2d');
            window.distanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Distance',
                        data: [],
                        borderColor: '#0369a1',
                        backgroundColor: 'rgba(3, 105, 161, 0.1)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Distance (km)'
                            }
                        }
                    }
                }
            });
        }

        function updateDistanceChart() {
            if (!window.distanceChart) return;
            
            const labels = [];
            const data = [];
            let cumulative = 0;
            
            waypoints.forEach((wp, index) => {
                labels.push(`WP${index + 1}`);
                data.push(cumulative);
                
                if (index < waypoints.length - 1) {
                    const distance = calculateDistance(
                        wp.lat, wp.lng,
                        waypoints[index + 1].lat, waypoints[index + 1].lng
                    );
                    cumulative += distance;
                }
            });
            
            window.distanceChart.data.labels = labels;
            window.distanceChart.data.datasets[0].data = data;
            window.distanceChart.update();
        }

        // Mobile menu toggle
        document.getElementById('mobile-menu-button').addEventListener('click', function() {
            const menu = document.getElementById('mobile-menu');
            menu.classList.toggle('hidden');
        });

        // Waypoint mode toggle
        document.getElementById('add-waypoint-mode').addEventListener('click', function() {
            addingWaypoint = !addingWaypoint;
            this.classList.toggle('bg-primary-100');
            this.classList.toggle('text-primary');
            this.classList.toggle('bg-slate-100');
            this.classList.toggle('text-slate-600');
        });

        // Show/hide organisms
        document.getElementById('show-organisms').addEventListener('click', function() {
            organismMarkers.forEach(marker => {
                if (routeMap.hasLayer(marker)) {
                    routeMap.removeLayer(marker);
                    this.textContent = 'Show Organisms';
                } else {
                    routeMap.addLayer(marker);
                    this.textContent = 'Hide Organisms';
                }
            });
        });

        // Show/hide distance markers
        document.getElementById('show-distances').addEventListener('click', function() {
            distanceMarkers.forEach(marker => {
                if (routeMap.hasLayer(marker)) {
                    routeMap.removeLayer(marker);
                    this.textContent = 'Show Distances';
                } else {
                    routeMap.addLayer(marker);
                    this.textContent = 'Hide Distances';
                }
            });
        });

        // Distance unit change
        document.getElementById('distance-unit').addEventListener('change', function() {
            updateRoute();
        });

        // Tracking range slider
        document.getElementById('tracking-range').addEventListener('input', function() {
            const unit = document.getElementById('distance-unit').value;
            document.getElementById('range-value').textContent = `${this.value} km`;
            updateOrganismDistances();
        });

        // Calculate route button
        document.getElementById('calculate-route').addEventListener('click', function() {
            if (waypoints.length < 2) {
                alert('Please add at least 2 waypoints to calculate a route.');
                return;
            }
            
            this.textContent = 'Calculating...';
            setTimeout(() => {
                this.textContent = 'Calculate Route';
                updateRoute();
                updateDistanceChart();
                alert('Route calculated successfully!');
            }, 1000);
        });

        // Clear route button
        document.getElementById('clear-route').addEventListener('click', function() {
            // Clear all waypoints
            routeMarkers.forEach(marker => routeMap.removeLayer(marker));
            routePolylines.forEach(line => routeMap.removeLayer(line));
            distanceMarkers.forEach(marker => routeMap.removeLayer(marker));
            
            waypoints = [];
            routeMarkers = [];
            routePolylines = [];
            distanceMarkers = [];
            totalDistance = 0;
            
            updateRouteSummary();
            updateWaypointsList();
            updateWaypointDetails();
            updateDistanceChart();
        });

        // Button handlers
        document.getElementById('plan-route').addEventListener('click', function() {
            document.getElementById('calculate-route').click();
        });

        document.getElementById('mobile-plan-route').addEventListener('click', function() {
            document.getElementById('calculate-route').click();
        });

        document.getElementById('save-route').addEventListener('click', function() {
            if (waypoints.length === 0) {
                alert('No route to save.');
                return;
            }
            alert('Route saved successfully!');
        });

        document.getElementById('export-route').addEventListener('click', function() {
            if (waypoints.length === 0) {
                alert('No route to export.');
                return;
            }
            
            const routeData = {
                waypoints: waypoints,
                totalDistance: totalDistance,
                unit: document.getElementById('distance-unit').value,
                timestamp: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(routeData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = 'route_export.json';
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        });

        document.getElementById('share-route').addEventListener('click', function() {
            if (waypoints.length === 0) {
                alert('No route to share.');
                return;
            }
            alert('Route shared successfully!');
        });

        document.getElementById('route-history').addEventListener('click', function() {
            alert('Route history feature coming soon!');
        });

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initRouteMap();
            initDistanceChart();
            
            // Show organisms by default
            setTimeout(() => {
                organismMarkers.forEach(marker => routeMap.addLayer(marker));
            }, 100);
        });
    </script>
<script id="dhws-dataInjector" src="../public/dhws-data-injector.js"></script>
</body>
</html>